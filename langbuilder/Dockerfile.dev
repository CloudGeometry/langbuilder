# Development Dockerfile for LangBuilder Backend
# This Dockerfile is optimized for development with hot-reload

FROM python:3.12-slim-bookworm

# Set working directory
WORKDIR /app

# Install system dependencies and uv
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    git \
    build-essential \
    curl \
    libpq-dev \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Install uv (Python package manager)
RUN pip install --no-cache-dir uv

# Copy only dependency files first (for better caching)
COPY pyproject.toml uv.lock* README.md ./

# Copy necessary directories for uv sync to work
COPY scripts ./scripts
COPY src/backend/base ./src/backend/base

# Create virtual environment and install dependencies
# Make sure libpq is available for psycopg compilation
ENV PATH="/app/.venv/bin:$PATH"
RUN uv venv && \
    . .venv/bin/activate && \
    uv sync --frozen --extra "postgresql" && \
    pip install psycopg[binary]

# Source code will be mounted as volume in docker-compose
# This allows hot-reload like 'make backend'

# Expose backend port
EXPOSE 8002

# Set environment variables for development (matching Makefile backend target)
ENV PYTHONUNBUFFERED=1
ENV LANGBUILDER_HOST=0.0.0.0
ENV LANGBUILDER_PORT=8002
ENV LOG_LEVEL=debug

# Create entrypoint script for development
RUN echo '#!/bin/bash\n\
set -e\n\
echo "Starting LangBuilder Backend (Dev Mode)..."\n\
. /app/.venv/bin/activate\n\
\n\
# Wait for PostgreSQL\n\
if [ -n "$LANGBUILDER_DATABASE_URL" ]; then\n\
  echo "Waiting for PostgreSQL..."\n\
  until pg_isready -h postgres -U langbuilder 2>/dev/null; do\n\
    echo "PostgreSQL is unavailable - sleeping"\n\
    sleep 2\n\
  done\n\
  echo "PostgreSQL is ready!"\n\
  \n\
  # Run migrations with explicit PostgreSQL URL\n\
  # The -x flag sets sqlalchemy.url which env.py now respects via get_main_option()\n\
  echo "Running database migrations against PostgreSQL..."\n\
  cd /app/src/backend/base/langbuilder\n\
  alembic -x sqlalchemy.url="$LANGBUILDER_DATABASE_URL" upgrade head || true\n\
  cd /app\n\
fi\n\
\n\
# Run uvicorn with auto-reload (matching Makefile backend command)\n\
echo "Starting uvicorn with auto-reload..."\n\
exec uvicorn \\\n\
  --factory langbuilder.main:create_app \\\n\
  --host 0.0.0.0 \\\n\
  --port 8002 \\\n\
  --reload \\\n\
  --reload-dir /app/src \\\n\
  --loop asyncio\n\
' > /docker-entrypoint-dev.sh && chmod +x /docker-entrypoint-dev.sh

ENTRYPOINT ["/docker-entrypoint-dev.sh"]
