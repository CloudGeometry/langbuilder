# Development Dockerfile for OpenWebUI Backend
# This Dockerfile is optimized for development with hot-reload

FROM python:3.11-slim-bookworm

# Set working directory
WORKDIR /app/backend

# Install system dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    git \
    build-essential \
    pandoc \
    gcc \
    netcat-openbsd \
    curl \
    jq \
    python3-dev \
    ffmpeg \
    libsm6 \
    libxext6 \
    && rm -rf /var/lib/apt/lists/*

# Install uv for faster dependency management
RUN pip3 install --no-cache-dir uv

# Copy necessary files for installation
COPY backend/requirements.txt ./requirements.txt
COPY CHANGELOG.md package.json /app/

# Install Python dependencies
RUN pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu --no-cache-dir && \
    uv pip install --system -r requirements.txt --no-cache-dir

# Create data directory
RUN mkdir -p /app/backend/data

# Expose backend port
EXPOSE 8080

# Set environment variables
ENV ENV=dev
ENV PORT=8080
ENV HOST=0.0.0.0
ENV PYTHONUNBUFFERED=1

# Health check
HEALTHCHECK CMD curl --silent --fail http://localhost:8080/health | jq -ne 'input.status == true' || exit 1

# Run backend with uvicorn and auto-reload
# The --reload flag enables hot-reloading on code changes
CMD ["sh", "-c", "python -m uvicorn open_webui.main:app --host 0.0.0.0 --port 8080 --reload --forwarded-allow-ips '*'"]
